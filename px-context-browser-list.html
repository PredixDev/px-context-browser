<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-polymer-font-awesome/px-icon-set.html"/>
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html"/>
<link rel="import" href="css/px-context-browser-list-styles.html"/>

<dom-module id="px-context-browser-list">
  <template>
    <style include="px-context-browser-list-styles"></style>

    <div class="search">
      <template is="dom-if" if="[[canFilter]]">
        <iron-a11y-keys id="a11y" target="[[_searchEl]]" keys="tab" on-keys-pressed="_handleTabKey"></iron-a11y-keys>
        <iron-a11y-keys id="a11y" target="[[_searchEl]]" keys="enter" on-keys-pressed="_handleEnterKey"></iron-a11y-keys>
        <iron-a11y-keys id="a11y" target="[[_searchEl]]" keys="left right up down" on-keys-pressed="_handleArrowKeys"></iron-a11y-keys>
        <div class="search__form">
          <input
              id="search"
              class="text-input search__box"
              placeholder="Filter"
              value="{{filter::input}}"
              autocomplete="off"
              tabindex="0">
          </input>
          <template is="dom-if" if="[[_showFilterIcon(filter)]]">
            <iron-icon class="search__icon" icon="px:filter"></iron-icon>
          </template>
          <template is="dom-if" if="[[_showClearIcon(filter)]]">
            <iron-icon id="close" class="search__icon search__icon--tappable" tabindex="-1" icon="px:close" on-tap="_clearFilter"></iron-icon>
          </template>
        </div>
      </template>
    </div>
    <div class="items">
      <slot name="items"></slot>
    </div>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'px-context-browser-list',
    properties: {
      canFilter: {
        type: Boolean,
        value: false,
        observer: '_canFilterChanged'
      },

      filter: {
        type: String,
        notify: true,
        value: function() {
          if (this.canFilter) {
            return '';
          }
        }
      },

      _searchEl: {
        type: HTMLElement,
        value: function() {
          return Polymer.dom(this.root).querySelector('.search');
        }
      }
    },

    focusInput() {
      const searchEl = Polymer.dom(this.root).querySelector('#search');
      if (searchEl) {
        searchEl.focus();
      }
    },

    focusCloseIcon(evt) {
      const iconEl = Polymer.dom(this.root).querySelector('#close');
      if (iconEl) {
        iconEl.focus();
      }
    },

    isFilterActive() {
      return (typeof this.filter === 'string' && this.filter.length > 0);
    },

    _handleTabKey(evt) {
      const target = Polymer.dom(evt.detail.keyboardEvent).rootTarget;
      if (target.id === 'search' && this.isFilterActive()) {
        evt.detail.keyboardEvent.preventDefault();
        this.focusCloseIcon();
      }
    },

    _handleEnterKey(evt) {
      const target = Polymer.dom(evt.detail.keyboardEvent).rootTarget;
      if (target.nodeName === 'IRON-ICON' && this.isFilterActive()) {
        evt.detail.keyboardEvent.preventDefault();
        this._clearFilter();
        this.focusInput();
      }
    },

    _handleArrowKeys(evt) {
      const target = Polymer.dom(evt.detail.keyboardEvent).rootTarget;
      if (evt.detail.keyboardEvent.key === 'ArrowDown') {
        evt.detail.keyboardEvent.preventDefault();
        this.fire('focus-first-visible-item', {}, {cancelable:true});
      }
    },

    _showFilterIcon(filter) {
      return typeof filter === 'string' && filter.length === 0;
    },

    _showClearIcon(filter) {
      return typeof filter === 'string' && filter.length > 0;
    },

    _clearFilter() {
      this.filter = '';
    },

    _canFilterChanged(newVal, oldVal) {
      if (newVal !== oldVal) {
        this.filter = '';
      }
    }
  })
</script>
