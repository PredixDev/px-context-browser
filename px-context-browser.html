<link rel="import" href="../polymer/polymer.html"/>

<link rel="import" href="../px-app-helpers/px-app-asset/px-app-asset-behavior-graph.html"/>
<link rel="import" href="../px-app-helpers/px-app-asset/px-app-asset-behavior-browsable.html"/>
<link rel="import" href="../px-app-helpers/px-app-asset/px-app-asset-behavior-selectable.html"/>
<link rel="import" href="px-context-browser-panel.html"/>
<link rel="import" href="px-context-browser-header.html"/>
<link rel="import" href="px-context-browser-list.html"/>
<link rel="import" href="px-context-browser-item.html"/>

<dom-module id="px-context-browser">
  <template>
    <style>
      .column {
        display: none;
      }
      .column--active {
        display: block;
      }
    </style>

    <px-context-browser-panel>
      <!-- Header -->
      <template is="dom-if" if="[[active]]">
        <px-context-browser-header slot="header" label="[[active.label]]" on-tap="_handleHeaderTapped"></px-context-browser-header>
      </template>
      <!-- List -->
      <px-context-browser-list slot="body">
        <div slot="items" id="items">
          <template is="dom-repeat" items="[[_columns]]" as="column">
            <div class$="column [[column.classNames]]">
              <template is="dom-repeat" items="[[column.items]]" as="item" column$="[[index]]">
                <px-context-browser-item label="[[item.label]]" selected$="{{_isItemSelected(item, selected)}}" can-favorite can-select can-open on-tap="_handleItemTapped"></px-context-browser-item>
              </template>
            </div>
          </template>
        </div>
      </px-context-browser-list>
    </px-context-browser-panel>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'px-context-browser',

    behaviors: [
      PxAppBehavior.AssetGraph,
      PxAppBehavior.AssetSelectable,
      PxAppBehavior.AssetBrowsable
    ],

    properties: {
      _columns: {
        type: Array,
        value: function() {
          return [];
        }
      },

      _activeColumn: {
        type: Number,
        value: 0,
        observer: '_activeColumnChanged'
      }
    },

    listeners: {
      'px-app-asset-graph-created' : '_addRootColumn',
      'px-app-asset-activated' : '_updateColumns'
    },

    _addRootColumn() {
      this.splice('_columns', 0, 1, {
        index: 0,
        classNames: 'column--active',
        items: this.items
      });
      // var prevCol = this._columns[0];
      // this._columns[0] = {
      //   index: 0,
      //   name: 'foo',
      //   items: this.items
      // };
      // this.notifySplices('_columns', [{
      //   index: 0,
      //   removed: prevCol,
      //   addedCount: 1,
      //   object: this._columns,
      //   type: 'splice'
      // }]);
      // this.notifyPath('_columns.#0.name');
    },

    _updateColumns(evt) {
      let {item, path} = evt.detail;
      let splices = [];

      for (let i=0; i<path.length; i++) {
        let column = this._columns[i+1];
        if (typeof column !== 'object' || typeof column.items !== 'object' || column.items !== path[i].children) {
          splices.push({
            index: i+1,
            addedCount: 1,
            removed: column ? column : {},
            object: this._columns,
            type: 'splice'
          });

          this._columns[i+1] = {
            index: i+1,
            classNames: '',
            items: path[i].children
          };
        }
      }

      if (splices.length > 0) {
        this.notifySplices('_columns', splices);
      }

      this._activeColumn = path.length;
    },

    _activeColumnChanged(newColumnIndex) {
      if (typeof this._columns !== 'object') return;

      for (let column of this._columns) {
        if (column.index !== newColumnIndex && column.classNames.indexOf('column--active') > -1) {
          column.classNames = column.classNames.replace('column--active', '').replace(/\s\s/, '');
          this.notifyPath(`_columns.#${column.index}.classNames`);
        }
        if (column.index === newColumnIndex && column.classNames.indexOf('column--active') === -1) {
          column.classNames = `${column.classNames} column--active`;
          this.notifyPath(`_columns.#${column.index}.classNames`);
        }
      }
    },

    _handleItemTapped(evt) {
      const $root = Polymer.dom(evt).path[0];
      const action = $root.getAttribute('asset-action');
      const item = evt.model.item;
      if (typeof action === 'string' && action.length > 0 && typeof item === 'object') {
        switch(action) {
          case 'activate':
            this.activate(item, 'DOM_EVENT');
            break;
          case 'select':
            this.select(item, 'DOM_EVENT');
            break;
          case 'favorite':
            // @TODO: Implement favorite storage/notification behavior
            break;
        }
      }
    },

    _handleHeaderTapped(evt) {
      const path = Polymer.dom(evt).path;
      let action;

      for (let i=path.length-1; i>-1; i--) {
        if (path[i] instanceof Node && path[i].hasAttribute && path[i].hasAttribute('asset-action')) {
          action = path[i].getAttribute('asset-action');
          break;
        }
      }

      if (typeof action !== 'string' || action.length === 0)  return;

      if (action === 'back' && this._activeColumn === 1) {
        this.activate(null, 'DOM_EVENT');
        this._activeColumn = 0;
        return;
      }

      if (action === 'back' && this._activeColumn > 1 && this.activeParent) {
        this.activate(this.activeParent, 'DOM_EVENT');
      }
    },

    _isItemSelected(item, selected) {
      return typeof selected === 'object' && selected === item;
    }
  })
</script>
