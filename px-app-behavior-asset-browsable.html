<script>
  (function() {
    'use strict';

    /* Ensures the behavior namespace is created */
    window.PxAppBehavior = (window.PxAppBehavior || {});

    /**
     *
     *
     * @polymerBehavior PxAppBehavior.AssetBrowsable
     */
    PxAppBehavior.AssetBrowsable = {
      properties: {
        active: {
          type: Object,
          notify: true,
          value: null
        },
        activeRoute: {
          type: Array,
          notify: true
        },
        activePath: {
          type: Array,
          notify: true,
          readOnly: true,
          value: null
        },
        activeParent: {
          type: Object,
          notify: true,
          readOnly: true,
          value: null
        },
        activeSiblings: {
          type: Object,
          notify: true,
          readOnly: true,
          value: null
        },
        activeChildren: {
          type: Object,
          notify: true,
          readOnly: true,
          value: null
        },
      },

      created() {
        this._lastActivation = {
          source: null,
          reason: null,
          item: null
        };
      },

      listeners: {
        'px-app-asset-should-be-activated' : '_assetActivatedByEvent'
      },

      /**
       * Activates an item. Call with an object that is a direct reference to one
       * of the `items` objects. To clear the activated item, call with `null`.
       *
       * An optional source of the change can be provided as a string.
       */
      activate(item, source='METHOD') {
        if (item === null && this._lastActivation.item !== null) {
          this._clearActiveAsset(source);
          return {source:source, cleared:true};
        }
        if (!item || this._lastActivation.item === item) return;

        if (this._assetGraph.hasNode(item)) {
          return this._activateAsset(item, source);
        } else {
          throw new Error(`The following item could not be found in the items graph:
          ${JSON.stringify(item)}`);
        }
      },

      /**
       * Handles activation from events fired by children. The event `detail.item`
       * should be a reference an item in the asset graph.
       */
      _assetActivatedByEvent(evt) {
        evt.stopPropagation();
        if (evt.detail.item) {
          this._activateAsset(evt.detail.item, 'DOM_EVENT');
        }
      },

      /**
       * Updates the active item when the `activeRoute` changes.
       */
      _assetActivatedByRoute(route) {
        if ((route === null && this._lastActivation.route !== null) || (Array.isArray(route) && !route.length && Array.isArray(this._lastActivation.route) && this._lastActivation.route.length > 0)) {
          this._clearActiveAsset('ROUTE_CHANGED');
          return;
        }
        if (!route || this._lastActivation.route === route) return;

        const item = this._assetGraph.getNodeAtRoute(route);
        if (item) {
          this._activateAsset(item, 'ROUTE_CHANGED');
        } else {
          throw new Error(`The route ${JSON.stringify(route)} could not be found in the items graph.`)
        }
      },

      /**
       * Updates other active item properties when `active` changes.
       */
      _assetActivatedByReference(item) {
        if (item === null && this._lastActivation.item !== null) {
          this._clearActiveAssetdAsset('ITEM_CHANGED');
          return;
        }
        if (!item || this._lastActivation.item === item) return;

        if (this._assetGraph.hasNode(item)) {
          this._activateAsset(item, 'ITEM_CHANGED');
        } else {
          throw new Error(`The following item could not be found in the items graph:
          ${JSON.stringify(item)}`)
        }
      },

      /**
       * Gets item metadata from the AssetGraph and updates internaly APIs
       */
      _activateAsset(item, source) {
        const {path, route, parent, children, siblings} = this._assetGraph.getNodeInfo(item);
        this._lastActivation = {
          item: item,
          source: source,
          route: route
        }
        if (this.active !== item) {
          this.set('active', item);
        }
        this.set('activeRoute', route);
        this._setActivePath(path);
        this._setActiveParent(parent);
        this._setActiveChildren(children);
        this._setActiveSiblings(siblings);

        let details = {
          source,
          item,
          route,
          path,
          parent,
          children,
          siblings
        };

        this.fire('px-app-asset-activated', details);
        return details;
      },
      /**
       * Fired when a new item is activated. Includes details about how the item
       * was activated, and information about the new active item.
       *
       * The `source` property is a string describing what triggered
       * the activation:
       *
       *   * 'DOM_EVENT' - the user interacted with an item and activated it
       *   * 'ROUTE_CHANGED' - the array bound to `activeRoute` changed
       *   * 'ITEM_CHANGED' - the object bound to `active` changed
       *   * 'METHOD' - the `activate()` method was called
       *   * 'ROUTE_METHOD' - the `activateRoute()` method was called
       *
       * The event will have the following properties:
       *
       *   * {Object} detail - Contains the event details
       *   * {String} detail.source - Info about the change trigger, see above
       *   * {Object} detail.item - Reference to the active item
       *   * {Array} detail.route - Route from the top of the graph to the active item
       *   * {Array} detail.path - Path from the top of the graph to the active item
       *   * {Object|null} detail.parent - Reference to the active item's parent, or null if no parent defined
       *   * {Array} detail.children - Reference to the the active item's children, or an empty array if no children defined
       *   * {Array} detail.siblings - Reference to the the active item's siblings, or an array with only the active item if no siblings defined
       *
       * @event px-app-asset-activated
       */

       _clearActiveAsset(source) {
         this._lastActivation = {
           item: null,
           source: null,
           route: null
         };
         this.set('active', null);
         this.set('activeRoute', null);
         this._setActivePath(null);
         this._setActiveParent(null);
         this._setActiveChildren(null);
         this._setActiveSiblings(null);
         this.fire('px-app-asset-active-cleared');
       }
       /**
        * Fired when the active item is cleared and no new item is activated.
        *
        * The `source` property is a string describing what triggered
        * the clearing:
        *
        *   * 'DOM_EVENT' - user interaction cleared the active item
        *   * 'ROUTE_CHANGED' - the array bound to `activeRoute` changed
        *   * 'ITEM_CHANGED' - the object bound to `active` changed
        *   * 'METHOD' - the `activate()` method was called with `null`
        *   * 'ROUTE_METHOD' - the `activateRoute()` method was called with `null` or an empty array
        *
        * @event px-app-asset-active-cleared
        */
    };
  })();
</script>
